user  root;
worker_processes  16;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

#env serviceName;
#env servicePort;

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

     log_format main escape=none '$remote_addr | $upstream_addr |  $upstream_response_time | $remote_user | $time_local | $request | $request_time | $status | $body_bytes_sent | $http_referer | $http_user_agent | $http_x_forwarded_for | $upstream_status';

    #access_log  logs/access.log  main;
    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    gzip  on;
    gzip_min_length 1;
    #gzip_buffers     4 16k;
    gzip_http_version 1.0;
    gzip_comp_level 2;
    gzip_types   application/json text/plain application/javascript application/x-javascript text/css application/xml;
    gzip_vary on;

    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";

    proxy_buffer_size 16k;

    proxy_buffers 4 16k;

    client_max_body_size 30m;
	
	merge_slashes off;


 upstream gateway {
         server bcoc-extranet-gateway:9100;
 }


upstream amg{
    server 7.220.11.216:31739;
}

upstream minio_api {
    server minio-service:9000  max_fails=3 fail_timeout=5s;
 }

lua_package_path '/usr/local/openresty/custom/?.lua;;';

server {
   listen 9002;
   server_name minio_api;
   location /{
   proxy_pass      http://minio_api;
   proxy_set_header Host $http_host;
}
}
server {
        listen       1080;
        server_name  _;
       # rewrite ^(.*) https://$server_name$1 permanent; #http 跳转 https

        access_log  logs/bcoc-mall-7f57759b5d-cj6l9/nginx.access.log  main;
        error_log  logs/bcoc-mall-7f57759b5d-cj6l9/nginx.error.log info;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        #添加X-Frame-Options 响应头配置避免点击劫持攻击
        add_header X-Frame-Options SAMEORIGIN;
        #STS 响应头增加 2021-10-21 (安全扫描要求)
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
        #CSP 响应头增加 2021-10-21 (安全扫描要求)
        add_header X-Content-Type-Options: nosniff;
        add_header X-XSS-Protection "1; mode=block";            
        add_header Content-Security-Policy "default-src 'self' data: blob: 'unsafe-inline'; script-src 'self'  'unsafe-inline' 'unsafe-eval' data: blob:;frame-ancestors 'none';";

        location /health {
            #nginx健康探针,k8s使用
            return 200;
        }

        error_page 404 403 500 502 503 504 = /error.html;                                                                                                                                                                                     
        location = /error.html {                                                                                        
            root /usr/local/openresty/nginx/html;                                                                     
        } 

        location ^~ / {
                #root html;
                alias /usr/local/openresty/bigscreen/;
                index index.html index.htm;
                try_files $uri  $uri/  /index.html;
                client_max_body_size  150m;
           }

		   location /api/{
               client_max_body_size 50M;
               proxy_pass http://kshpt:8080/;
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
          }	

          location /image_proxy/{
            proxy_pass http://minio_api/;
          }	

        location /mall {
            alias /hwapp/hwcrm/bcoc-frontend/bcoc-frontend-pro/dist/;
        }

        # location /bigscreen {
        #     alias /hwapp/hwcrm/bcoc-frontend/bcoc-bigscreen-git-front/dist/;
        # }

        # location /mall/bigscreen {
        #     alias /usr/local/openresty/bigscreen/;
        #           index index.html index.htm;
        #           try_files $uri  $uri/  /index.html;
        #           client_max_body_size  150m;
        # }

        # location /mall/bigscreen/image_proxy {
        #     proxy_pass http://minio-service:9000/;
        # }

        # location /mall/bigscreen/api {
        #     proxy_pass http://kshpt:19999/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        # }


        location /mall/openmgr{
            rewrite ^/mall/(.*)$ /$1 break;
            proxy_pass http://gateway;
        #    proxy_cookie_path / "/; httponly; secure; SameSite=Lax";
        }

        location /mall/openmgr/rest/active/gdActivityMgr/bcocTestService{
	          rewrite ^/mall/openmgr/rest/active/(.*)$ /$1 break;
            proxy_pass http://10.103.230.246:9109;
        }

        location /mall/bcoc/base {
            client_max_body_size 10m;
            rewrite ^/mall/bcoc/base/(.*)$ /$1 break;
            proxy_pass http://gateway;
         #   proxy_cookie_path / "/; secure; SameSite=Lax";
        }
        
        location /bcoc/upload/APPDEFINEDOC {
            return 500;
        }

        location /bcoc/upload/SERVICEAPPLY {
            return 500;
        }
        
        location /bcoc/upload/USERAUTH {
            return 500;
        }

        location /bcoc/upload/USERSIGN {
            return 500;
        }
        
       location /bcoc/upload/ADVERTIZEDEF/ {
                  alias /hwapp/hwcrm/upload/ADVERTIZEDEF/;
              }
      	    location /bcoc/upload/APPDEFINE/ {
                  alias /hwapp/hwcrm/upload/APPDEFINE/;
              }
      	    location /bcoc/upload/APPDEFINEDOC/ {
                  alias /hwapp/hwcrm/upload/APPDEFINEDOC/;
              }
      	    location /bcoc/upload/COOPECO/ {
                  alias /hwapp/hwcrm/upload/COOPECO/;
              }
      	    location /bcoc/upload/DOCDOWNLOADJPG/ {
                  alias /hwapp/hwcrm/upload/DOCDOWNLOADJPG/;
              }
      	    location /bcoc/upload/FUNCDIR/ {
                  alias /hwapp/hwcrm/upload/FUNCDIR/;
              }
      	    location /bcoc/upload/INTRODUCTORY/ {
                  alias /hwapp/hwcrm/upload/INTRODUCTORY/;
              }
      	    location /bcoc/upload/PARTNERDEF/ {
                  alias /hwapp/hwcrm/upload/PARTNERDEF/;
              }
      	    location /bcoc/upload/PRODUCT/ {
                  alias /hwapp/hwcrm/upload/PRODUCT/;
              }
      	    location /bcoc/upload/PRODUCTDIR/ {
                 alias /hwapp/hwcrm/upload/PRODUCTDIR/;
              }
      	    location /bcoc/upload/PRODUCTJPGVIDEO/ {
                  alias /hwapp/hwcrm/upload/PRODUCTJPGVIDEO/;
              }
      	    location /bcoc/upload/RICHTEXT/ {
                  alias /hwapp/hwcrm/upload/RICHTEXT/;
              }
      	    location /bcoc/upload/SCENESCLASSINFO/ {
                  alias /hwapp/hwcrm/upload/SCENESCLASSINFO/;
              }
      	    location /bcoc/upload/SERVICEAPPLY/ {
                  alias /hwapp/hwcrm/upload/SERVICEAPPLY/;
              }
      	    location /bcoc/upload/SOLUTION/ {
                  alias /hwapp/hwcrm/upload/SOLUTION/;
              }
      	    location /bcoc/upload/SOLUTIONJPGVIDEO/ {
                  alias /hwapp/hwcrm/upload/SOLUTIONJPGVIDEO/;
              }
      	    location /bcoc/upload/SOLUTIONRAR/ {
                  alias /hwapp/hwcrm/upload/SOLUTIONRAR/;
              }
      	    location /bcoc/upload/SYSTEMDESC/ {
                  alias /hwapp/hwcrm/upload/SYSTEMDESC/;
              }
            location /bcoc/upload/img/ {
                  alias /hwapp/hwcrm/upload/img/;
              }


        location @router {
            rewrite ^.*$ /index.html last;
        }
    }
}

